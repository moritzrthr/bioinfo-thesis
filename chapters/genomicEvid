 
 
 
 OK WIR BRAUCHEN NOCH 2 neue sections


 
1.genomic validation dass wir panel sequencing daten hatten

WIE wir panel seq weiterverabrietet haben:
# Zeigt die ersten Zeilen der JSON-Datei an, um die Struktur zu verstehen
zless /s/project/clinspect-m/DATA/clinspect_m_data/fresh_frozen/genomics_data/H-2021-10649_DNA_MergedVariants_Annotated.json.gz
Technische Details aus dem JSON-Header
Annotator: Nirvana (Version 3.2.3).
Genome Assembly: GRCh37 (hg19). Das ist wichtig, falls du Koordinaten mit neueren Proteom-Daten (oft GRCh38) abgleichen willst.
Datenquellen: VEP (Ensembl), ClinVar, COSMIC (Tumor-spezifisch!), dbSNP und gnomAD. Dass COSMIC dabei ist, zeigt, dass gezielt nach bekannten Krebsmutationen gesucht wurde.
Variant Information: Du hast Zugriff auf hgvsg (genomisch) und transcripts (Auswirkung auf das Protein).
To identify potential tumor-specific peptides and single amino acid variants (SAAVs), genomic panel sequencing data was processed using the Variant Effect Predictor (VEP). Somatic mutations were filtered based on their functional impact, prioritizing missense variants and in-frame indels (categorized as MODERATE or HIGH impact). For each patient sample, the genomic coordinates were mapped to protein positions (stored in combined_annotated_wIDs.csv), enabling a direct comparison between de novo predicted peptide sequences and the patient-specific mutational landscape. This integration allowed us to validate whether the transformer-based model could identify non-canonical peptides that are absent from the UniProt reference database

wie wir dann das vgl haben:
fuer jedes peptid was gut zu einem KRebsgen aus den 500 panel seq genen aliniert wurde bis auf wenige mismatches und diese snp erklaerbar waren haben wir dann die genaue position im protein bestimmt
zudem die uniprot ids vom alignment auf die ensbml ids die wir aus dem VEP hatten gemappt
dann immer geschaut ob wir fuer diesen snp auch genomic evidence haben




2.
spectral evidence inkl koina erklaer und def fuer SA
alkso erkaleren dass wir immer das experimentelle spektrum mit dem theoretischen vergleichen und wie wir den SA score berechnen
also definition von spectrakl angle reinmachen zudem sagen dass wir koina verwendet haben von wilhelmlab
und die version mit unseren mass spec settings also CE 32 usw um mgl aehnliches spektrum zu bekommen

wir nahmen Prosit_2024_intensity_PTMs_gl  welches auch tmt daten kann und zudem ptms
d h wir haben die predictions von unserem modell wieder in unimod format gebracht und dann das theoretische sprkturm geholt und dann die metriken berechnet



 
 
 
 >>>>>VORHERIGER TEIL
 
 two epochs was applied. Regularization was introduced via a weight decay of $1 \times 10^{-5}$ and label smoothing with a factor of 0.01, improving generalization in the presence of heterogeneous modification patterns.

Training was performed using mixed-precision arithmetic with \textit{bf16} precision, reducing memory consumption and improving computational efficiency on modern GPU architectures without compromising numerical stability \cite{Micikevicius2017}. Model selection was based on validation loss, and the checkpoint with the lowest validation loss was retained for all downstream analyses.


\section{Evaluation Strategy and Performance Metrics}


To rigorously assess the performance of the TMT-adapted de novo sequencing model, a multi-faceted evaluation framework was established. The primary objective is to determine how well the model generalizes to TMT-labeled spectra and various post-translational modifications (PTMs) compared to traditional database-driven assignments.

\subsection{Confidence Scoring and Peptide Ranking}
Each peptide-spectrum match (PSM) generated by the model is assigned a confidence score to facilitate ranking and quality control. Following the architecture of Transformer-based models like Casanovo and ModaNovo, we derive a peptide-level score by calculating the arithmetic mean of the individual amino acid confidence scores, which are obtained from the softmax output at each decoding step \cite{Yilmaz2022}.

To ensure the physical plausibility of the predictions, a mass-matching constraint is applied. If the calculated mass of the predicted sequence (including PTMs and TMT labels) deviates from the observed precursor mass beyond a defined tolerance (e.g., 10 ppm), the peptide score is penalized. This integration of spectral evidence and thermodynamic constraints is crucial for distinguishing between high-confidence sequences and plausible but incorrect mass-shift combinations.

\subsection{Precision-Coverage Analysis and Stratification}
The core metric for evaluating the model's predictive power is the precision-coverage curve. This allows for a threshold-independent assessment of how many peptides can be identified at a given reliability level. For this study, we specifically focus on the Area Under the Precision-Coverage Curve (AUPCC), calculated using the trapezoidal rule \cite{Pedregosa2011}.

A critical aspect of our evaluation is the **stratified analysis**. To understand the specific impact of the TMT expansion, we evaluate the performance separately for:
\begin{itemize}
    \item \textbf{TMT-labeled spectra:} To measure the success of the model adaptation to systematic mass shifts.
    \item \textbf{Unlabeled (non-TMT) spectra:} To ensure that the model retains its general sequencing capabilities without losing performance on standard data (preventing "catastrophic forgetting").
\end{itemize}

Precision ($P$) and Coverage ($C$) at a score threshold $t$ are defined as:
\begin{equation}
    P(t) = \frac{|\text{Correct PSMs with score} \geq t|}{|\text{Total predictions with score} \geq t|}
\end{equation}
\begin{equation}
    C(t) = \frac{|\text{Predictions with score} \geq t|}{|\text{Total ground truth identifications}|}
\end{equation}

A PSM is considered correct if the sequence exactly matches the ground truth identified by a database search (e.g., MaxQuant or MSFragger), treating isobaric amino acids such as Leucine and Isoleucine as equivalent \cite{KlaprothAndrade2025}.

To uncover biological insights beyond standard searches, we evaluate the precision for specific PTM-amino acid combinations. For a given modification (e.g., Phosphorylation at T), we subset the ground truth data to include all peptides containing this specific shift. This granular view ensures that the model's ability to handle complex, multiplexed PTM patterns is validated across both TMT and non-TMT backgrounds.




\section{Application to Clinical Glioma Data}

To evaluate the practical utility and robustness of the TMT-adapted model in a real-world clinical context, we applied it to a large-scale, independent cancer dataset. Unlike the synthetic and curated libraries used for fine-tuning, this dataset represents the inherent complexity of clinical proteomics, characterized by high dynamic range and heterogeneous post-translational modifications.


\subsection{Experimental Dataset: The ClinSpect-M Glioma Cohort}

The model was used on an unpublished clinical dataset provided by the Kusterlab [refernce tbd]. This cohort comprises approximately 300 Glioma patient samples, representing a diverse spectrum of tumor grades and molecular subtypes. The primary objective was to assess whether the transformer-based architecture could identify peptide sequences and PTMs that remain elusive to traditional database-searching algorithms in a high-throughput multiplexed setting.

\subsection{Data Acquisition and Large-Scale Preprocessing}

The dataset consists of approximately 6.5 million tandem mass spectra, originally acquired as Orbitrap-based raw files (.raw). To ensure compatibility with the model input, raw files were converted into Mascot Generic Format (MGF) using the \texttt{ThermoRawFileParser} (v2.0.0) \cite{Hulstaert2020}. 

During preprocessing, all MS1 precursor scans and MS3 reporter ion scans were excluded from the sequencing workflow. The focus was restricted to MS2 fragment spectra, which contain the peptide backbone information necessary for sequence reconstruction. 

\subsection{Peptide Identification Pipeline}

To achieve a comprehensive analysis of the Glioma proteome, we employed a dual-strategy approach: \textit{de novo} sequencing for discovery and a database-driven search as a validation baseline.

\paragraph{De Novo Sequencing Configuration}
The sequencing of the TMT-labeled spectra was performed using the adapted ModaNovo framework. To ensure high-quality sequence predictions and to accommodate the systematic shifts introduced by TMT, the following parameters were applied:
\begin{itemize}
    \item \textbf{Mass Tolerances:} The precursor mass tolerance was set to 50 ppm to account for potential drift in large-scale clinical datasets. The isotope error range was restricted to $[0, 3]$.
    \item \textbf{Spectrum Processing:} To reduce noise and optimize inference speed, only the 150 most intense peaks per spectrum (\texttt{n\_peaks}) within an $m/z$ range of 50.0 to 2500.0 were retained. Peaks within a 2.0 Da window of the precursor $m/z$ were removed to prevent interference from residual precursor signals.
    \item \textbf{Sequence Constraints:} A minimum peptide length of 6 amino acids and a maximum of 100 were enforced. For the decoding process, a beam search with a width of $n\_beams = 1$ was utilized, focusing on the top-ranked match to maximize throughput.
    \item \textbf{Quality Control:} Only spectra with a precursor charge of $\leq 10$ and a relative intensity threshold of 0.01 were processed.
\end{itemize}

\paragraph{Database Search Configuration (MaxQuant Baseline)}
To provide a complementary ground-truth baseline and validate the \textit{de novo} results, all Glioma datasets were processed using MaxQuant (version 2.1.3.0) \cite{Tyanova2016}. This step is crucial to determine the "searchable" fraction of the proteome and to identify which spectra remain "unexplained" by traditional methods, thereby highlighting the discovery potential of our model beyond database-driven searches.

The search was conducted against the human reference proteome (UniProt UP000005640) with parameters harmonized to the experimental design:
\begin{itemize}
    \item \textbf{Protease:} Trypsin/P was specified, allowing for cleavage C-terminal to Lysine and Arginine, even when followed by Proline.
    \item \textbf{Fixed Modifications:} Carbamidomethylation of cysteine (+57.021 Da) and TMT labeling of Lysine and the peptide N-terminus (+229.163 Da) were set as static modifications.
    \item \textbf{Variable Modifications:} To capture the regulatory landscape of the cancer samples, oxidation (M), acetylation (n-Term) and phosphorylation (S/T/Y) were included in the search space.
\end{itemize}





\subsection{Peptide Alignment and Sequence Validation}
To validate the biological origin of the predicted \textit{de novo} sequences and to distinguish between known peptides and potential novel discoveries, a sequence alignment against the reference proteome was performed. This step is crucial because \textit{de novo} models predict sequences solely based on spectral features, which may include errors or biologically plausible variations not present in the reference database.

\paragraph{Mass-Spectrometric Ambiguities and Encoding Strategy}
A fundamental challenge in de novo peptide sequencing is the existence of isobaric or near-isobaric amino acid residues. Since the models primarily operates on mass-to-charge ratios ($m/z$), it identifies mass shifts rather than chemical identities. While transformer-based architectures can theoretically also learn to consider aminoacid context when mass shifts overlap, this still remains unevaluated and therefore we resolve the ambiguities. 

We identified several critical ambiguities:
\begin{itemize}
    \item \textbf{I/L Equivalence:} Leucine (L) and Isoleucine (I) are structural isomers with an identical monoisotopic mass of $113.08406$ Da, making them indistinguishable in HCD spectra.
    \item \textbf{Deamidation-induced Ambiguities:} The deamidation of Glutamine (Q) and Asparagine (N) results in a mass increase of $+0.984016$ Da. This shift leads to these pairs:
    \begin{itemize}
        \item Glutamic acid (E, $129.042593$ Da) and deamidated Glutamine (Q[+0.98], $129.042594$ Da).
        \item Aspartic acid (D, $115.026943$ Da) and deamidated Asparagine (N[+0.98], $115.026943$ Da).
    \end{itemize}
    \item \textbf{Pyro-glutamate Formations:} Ambiguities also occur between Pyro-glu E and Pyro-glu Q. However, as these appeared in less than 1\% of the detected spectra in our dataset, they were not explicitly encoded to avoid over-complicating the search space.
\end{itemize}

\paragraph{BLASTp Configuration and Ambiguity Handling}
Alignment was executed using \texttt{Protein-Protein BLAST} (version 2.17.0+) against the human reference proteome (UniProt UP000005640). Because the reference proteome consists of unmodified sequences, a direct match of a deamidated peptide (predicted as D or E by the model) against a genomic N or Q would fail under standard parameters.

To resolve this, we implemented a specialized encoding strategy using IUPAC ambiguity codes:
\begin{itemize}
    \item All predicted \textbf{D} residues (which could be $N[+0.98]$) were replaced with \textbf{B} (asparagine or aspartic acid).
    \item All predicted \textbf{E} residues (which could be $Q[+0.98]$) were replaced with \textbf{Z} (glutamine or glutamic acid).
\end{itemize}

An alternative approach would have been the implementation of a custom substitution matrix. However, the BLASTp  does not support user-defined matrices for short peptide searches without extensive modification of the source code. Therefore, we utilized the \texttt{PAM30} matrix, which is optimized for short sequences and natively supports the \texttt{B} and \texttt{Z} codes.

% --- Visual Example for Thesis ---
\vspace{1em}
\noindent \textbf{Example of IUPAC Encoding for Deamidation Alignment:}
\begin{center}
\small
\begin{tabular}{rll}
    \textbf{Reference Proteome:} & \texttt{A V G \textbf{D} L T S \textbf{Q} R} & \\
    \textbf{De-novo Prediction:} & \texttt{A V G \color{red}{N} L T S \color{red}{E} R} & \textit{\footnotesize (Potential Mismatches)} \\
    \noalign{\smallskip}
    \cline{1-2}
    \noalign{\smallskip}
    \textbf{Standard BLASTp:}   & \texttt{A V G \color{red}{-} L T S \color{red}{-} R} & \textbf{\color{red}{Mismatch}} \\
    \textbf{Our Strategy (PAM30):} & \texttt{A V G \color{blue}{B} L T S \color{blue}{Z} R} & \textbf{\color{blue}{Perfect Match*}} \\
\end{tabular}
\end{center}
\textit{\footnotesize *Note: Both sequences are converted to IUPAC codes B (N/D) and Z (Q/E) prior to alignment, allowing the PAM30 matrix to score them as identical residues.}
\vspace{1em}

\paragraph{Alignment Parameters}
The alignment parameters were adjusted to account for the short nature of tryptic peptides. We set an E-value threshold of $2000$, as the small search space of a single peptide often results in high E-values despite perfect sequence identity. Furthermore, we used a \texttt{qcov\_hsp\_perc} of $80$ and disabled composition-based statistics (\texttt{comp\_based\_stats}) to prevent score inflation and ensure that short matches were not statistically penalized \cite{Altschul1997, Kersey2004}.


\paragraph{Post-Alignment Filtering and SNP Analysis}
The resulting alignments were further enriched to identify Single Nucleotide Polymorphisms (SNPs) and truncation events. To account for sequences extending beyond protein termini or alignment gaps, the full query and target sequences were retrieved. 
The number of mismatches was calculated by considering the \texttt{B} and \texttt{Z} equivalences. For each remaining mismatch, an automated codon-lookup was performed. A mismatch was classified as "SNP-explainable" if the transition between the predicted amino acid and the reference residue could be achieved by a single nucleotide substitution in the underlying codon. 

Cases involving gaps or truncations where the query extended beyond the reference boundaries were excluded from the SNP analysis to maintain high confidence in the mutation mapping.

